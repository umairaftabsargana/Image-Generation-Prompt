import React, { useState, useRef, useEffect } from 'react';
import { Header } from './components/Header';
import { Button } from './components/Button';
import { StepIndicator } from './components/StepIndicator';
import { SceneStyle, ScriptAnalysis, GeneratedScene, ImageReference } from './types';
import { analyzeScript, generateScenes } from './services/geminiService';
import { formatAllScenes, formatScenePrompt, generateHtmlExport } from './utils/format';

const App: React.FC = () => {
  // State
  const [step, setStep] = useState<number>(1);
  const [script, setScript] = useState<string>('');
  const [style, setStyle] = useState<SceneStyle>(SceneStyle.CINEMATIC);
  const [images, setImages] = useState<ImageReference[]>([]);
  
  // Analysis State
  const [isAnalyzing, setIsAnalyzing] = useState(false);
  const [analysis, setAnalysis] = useState<ScriptAnalysis | null>(null);
  const [sceneCount, setSceneCount] = useState<number>(0);

  // Generation State
  const [isGenerating, setIsGenerating] = useState(false);
  const [scenes, setScenes] = useState<GeneratedScene[]>([]);
  const [generationError, setGenerationError] = useState<string | null>(null);

  // Refs
  const resultsRef = useRef<HTMLDivElement>(null);
  const fileInputRef = useRef<HTMLInputElement>(null);

  const handleImageUpload = (e: React.ChangeEvent<HTMLInputElement>) => {
    const files = e.target.files;
    if (files && files.length > 0) {
      const newImages: ImageReference[] = [];
      const fileArray = Array.from(files);
      
      fileArray.forEach((file: File) => {
        const reader = new FileReader();
        reader.onloadend = () => {
          const base64String = reader.result as string;
          // Extract base64 data only (remove prefix)
          const base64Data = base64String.split(',')[1];
          newImages.push({
            file,
            previewUrl: URL.createObjectURL(file),
            base64: base64Data,
            mimeType: file.type
          });
          if (newImages.length === fileArray.length) {
            setImages(prev => [...prev, ...newImages]);
          }
        };
        reader.readAsDataURL(file);
      });
    }
  };

  const removeImage = (index: number) => {
    setImages(prev => prev.filter((_, i) => i !== index));
  };

  const handleAnalyze = async () => {
    if (!script.trim()) return;
    setIsAnalyzing(true);
    setGenerationError(null);
    try {
      const result = await analyzeScript(script);
      setAnalysis(result);
      setSceneCount(result.recommendedSceneCount);
      setStep(2);
    } catch (err) {
      console.error(err);
      setGenerationError("Failed to analyze script. Please try again.");
    } finally {
      setIsAnalyzing(false);
    }
  };

  const handleGenerate = async () => {
    setIsGenerating(true);
    setGenerationError(null);
    try {
      const result = await generateScenes(
        script, 
        sceneCount, 
        style, 
        images.map(img => ({ base64: img.base64, mimeType: img.mimeType }))
      );
      setScenes(result);
      setStep(3);
    } catch (err) {
      console.error(err);
      setGenerationError("Failed to generate scenes. The AI might be overloaded or the script is too long.");
    } finally {
      setIsGenerating(false);
    }
  };

  const handleCopyAll = () => {
    const text = formatAllScenes(scenes, style);
    navigator.clipboard.writeText(text);
    alert("All scene prompts copied to clipboard!");
  };

  const handleDownload = () => {
    const html = generateHtmlExport(scenes, style);
    const blob = new Blob([html], { type: 'text/html' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `CineScript_Scenes_${Date.now()}.html`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  };

  useEffect(() => {
    if (step === 3 && resultsRef.current) {
      resultsRef.current.scrollIntoView({ behavior: 'smooth' });
    }
  }, [step]);

  return (
    <div className="min-h-screen bg-cinema-900 text-gray-200 font-sans selection:bg-cinema-accent selection:text-black">
      <Header />
      
      <main className="container mx-auto px-4 py-8 max-w-5xl">
        <div className="text-center mb-10 space-y-2">
          <h2 className="text-3xl md:text-5xl font-serif font-bold text-white tracking-tight">
            Visualize Your Story
          </h2>
          <p className="text-gray-400 text-lg max-w-2xl mx-auto">
            Transform your script into highly detailed, AI-ready scene prompts with consistent styling and characters.
          </p>
        </div>

        <StepIndicator currentStep={step} />

        {/* STEP 1: INPUT */}
        {step === 1 && (
          <div className="space-y-8 animate-fade-in">
            {/* Style Selection */}
            <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
              {Object.values(SceneStyle).map((s) => (
                <button
                  key={s}
                  onClick={() => setStyle(s)}
                  className={`p-6 rounded-xl border-2 text-left transition-all duration-300 ${
                    style === s 
                      ? 'border-cinema-accent bg-cinema-800 shadow-lg shadow-cinema-accent/10' 
                      : 'border-cinema-700 bg-cinema-800/50 hover:border-gray-500'
                  }`}
                >
                  <div className={`w-4 h-4 rounded-full border mb-4 flex items-center justify-center ${
                    style === s ? 'border-cinema-accent' : 'border-gray-500'
                  }`}>
                    {style === s && <div className="w-2 h-2 rounded-full bg-cinema-accent" />}
                  </div>
                  <h3 className="font-bold text-lg text-white mb-1">{s}</h3>
                  <p className="text-sm text-gray-400">
                    {s === SceneStyle.CINEMATIC && "Realistic, dramatic lighting, film grain."}
                    {s === SceneStyle.REALISTIC && "True-to-life, documentary feel, sharp."}
                    {s === SceneStyle.STYLIZED_ANIMATION && "Pixar/Ghibli inspired, vibrant, expressive."}
                  </p>
                </button>
              ))}
            </div>

            <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
              {/* Script Input */}
              <div className="lg:col-span-2 space-y-4">
                <div className="flex justify-between items-center">
                   <label className="text-sm font-semibold uppercase tracking-wider text-gray-400">Script</label>
                   <span className="text-xs text-gray-600 bg-cinema-800 px-2 py-1 rounded">Unlimited Length</span>
                </div>
                <textarea
                  value={script}
                  onChange={(e) => setScript(e.target.value)}
                  placeholder="Paste your script here... (EXT. NIGHT - RAINY STREET...)"
                  className="w-full h-96 p-4 rounded-xl bg-cinema-800 border border-cinema-700 text-gray-100 placeholder-gray-600 focus:border-cinema-accent focus:ring-1 focus:ring-cinema-accent transition-all resize-none font-mono text-sm leading-relaxed"
                />
              </div>

              {/* Reference Images */}
              <div className="space-y-4">
                 <label className="text-sm font-semibold uppercase tracking-wider text-gray-400">Reference Images (Optional)</label>
                 <div 
                   onClick={() => fileInputRef.current?.click()}
                   className="w-full h-48 border-2 border-dashed border-cinema-700 rounded-xl flex flex-col items-center justify-center cursor-pointer hover:border-cinema-accent hover:bg-cinema-800/50 transition-all group"
                 >
                   <input 
                     type="file" 
                     multiple 
                     accept="image/*" 
                     className="hidden" 
                     ref={fileInputRef}
                     onChange={handleImageUpload}
                   />
                   <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className="w-8 h-8 text-gray-500 mb-2 group-hover:text-cinema-accent">
                      <path strokeLinecap="round" strokeLinejoin="round" d="M2.25 15.75l5.159-5.159a2.25 2.25 0 013.182 0l5.159 5.159m-1.5-1.5l1.409-1.409a2.25 2.25 0 013.182 0l2.909 2.909m-18 3.75h16.5a1.5 1.5 0 001.5-1.5V6a1.5 1.5 0 00-1.5-1.5H3.75A1.5 1.5 0 002.25 6v12a1.5 1.5 0 001.5 1.5zm10.5-11.25h.008v.008h-.008V8.25zm.375 0a.375.375 0 11-.75 0 .375.375 0 01.75 0z" />
                    </svg>
                   <span className="text-sm text-gray-500 group-hover:text-gray-300">Click to upload references</span>
                 </div>

                 {images.length > 0 && (
                   <div className="grid grid-cols-2 gap-2 mt-4">
                     {images.map((img, idx) => (
                       <div key={idx} className="relative group aspect-square rounded-lg overflow-hidden border border-cinema-700">
                         <img src={img.previewUrl} alt="ref" className="w-full h-full object-cover" />
                         <button 
                           onClick={() => removeImage(idx)}
                           className="absolute top-1 right-1 p-1 bg-red-600 text-white rounded-full opacity-0 group-hover:opacity-100 transition-opacity"
                         >
                           <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" className="w-3 h-3">
                              <path d="M6.28 5.22a.75.75 0 00-1.06 1.06L8.94 10l-3.72 3.72a.75.75 0 101.06 1.06L10 11.06l3.72 3.72a.75.75 0 101.06-1.06L11.06 10l3.72-3.72a.75.75 0 00-1.06-1.06L10 8.94 6.28 5.22z" />
                            </svg>
                         </button>
                       </div>
                     ))}
                   </div>
                 )}
              </div>
            </div>
            
            <div className="flex justify-end pt-6">
              <Button 
                onClick={handleAnalyze} 
                isLoading={isAnalyzing}
                disabled={!script.trim()}
                className="w-full md:w-auto"
              >
                {isAnalyzing ? "Analyzing Script..." : "Analyze Script"}
              </Button>
            </div>
          </div>
        )}

        {/* STEP 2: ANALYSIS & CONFIG */}
        {step === 2 && analysis && (
          <div className="max-w-2xl mx-auto bg-cinema-800/50 p-8 rounded-2xl border border-white/10 animate-fade-in backdrop-blur-sm">
             <h3 className="text-2xl font-serif font-bold text-white mb-6">Analysis Complete</h3>
             
             <div className="bg-cinema-900 p-6 rounded-xl border-l-4 border-cinema-accent mb-8">
               <p className="text-gray-300 italic mb-4">"{analysis.reasoning}"</p>
               <div className="flex items-center gap-2">
                  <span className="text-sm font-bold text-cinema-accent uppercase">Recommendation:</span>
                  <span className="text-white font-bold">{analysis.recommendedSceneCount} Scenes</span>
               </div>
             </div>

             <div className="space-y-6">
               <div className="flex flex-col gap-2">
                 <label className="text-sm font-medium text-gray-300">How many scenes do you want?</label>
                 <div className="flex gap-4">
                   <div className="relative flex-grow">
                     <input 
                       type="number" 
                       min={1} 
                       max={100}
                       value={sceneCount}
                       onChange={(e) => setSceneCount(Math.max(1, parseInt(e.target.value) || 0))}
                       className="w-full p-4 rounded-lg bg-cinema-900 border border-cinema-700 text-white focus:border-cinema-accent focus:ring-1 focus:ring-cinema-accent"
                     />
                   </div>
                 </div>
                 <p className="text-xs text-gray-500">
                   You can override the recommendation. More scenes = more granular detail.
                 </p>
               </div>

               <div className="flex gap-4 pt-4">
                 <Button variant="outline" onClick={() => setStep(1)} className="flex-1">Back</Button>
                 <Button 
                   onClick={handleGenerate} 
                   isLoading={isGenerating} 
                   className="flex-1"
                   icon={
                     <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" className="w-5 h-5">
                       <path fillRule="evenodd" d="M10.5 3.75a6.75 6.75 0 100 13.5 6.75 6.75 0 000-13.5zM2.25 10.5a8.25 8.25 0 1114.59 5.28l4.69 4.69a.75.75 0 11-1.06 1.06l-4.69-4.69A8.25 8.25 0 012.25 10.5z" clipRule="evenodd" />
                     </svg>
                   }
                 >
                   {isGenerating ? "Generating..." : "Generate Scenes"}
                 </Button>
               </div>
               
               {generationError && (
                 <div className="p-4 bg-red-900/30 border border-red-800 text-red-200 rounded-lg text-sm text-center">
                   {generationError}
                 </div>
               )}
             </div>
          </div>
        )}

        {/* STEP 3: RESULTS */}
        {step === 3 && scenes.length > 0 && (
          <div ref={resultsRef} className="space-y-8 animate-fade-in">
            <div className="flex flex-col md:flex-row justify-between items-center gap-4 bg-cinema-800 p-4 rounded-xl border border-white/5">
              <div>
                <h3 className="text-xl font-bold text-white">Generated {scenes.length} Scenes</h3>
                <p className="text-sm text-gray-400">Ready for Midjourney, Stable Diffusion, or DALL-E.</p>
              </div>
              <div className="flex gap-3">
                 <Button onClick={() => setStep(1)} variant="outline">New Script</Button>
                 <Button onClick={handleCopyAll} variant="secondary">Copy All</Button>
                 <Button onClick={handleDownload} variant="primary">Download HTML Report</Button>
              </div>
            </div>

            <div className="grid grid-cols-1 gap-6">
              {scenes.map((scene) => (
                <div key={scene.sceneNumber} className="group relative bg-black/40 border border-cinema-700 hover:border-cinema-accent/50 rounded-xl overflow-hidden transition-all duration-300">
                  <div className="absolute top-0 left-0 w-1 h-full bg-cinema-accent opacity-0 group-hover:opacity-100 transition-opacity" />
                  
                  <div className="p-6 md:p-8">
                    <div className="flex justify-between items-start mb-4">
                      <span className="inline-block px-3 py-1 bg-cinema-accent text-cinema-900 text-xs font-bold uppercase rounded-sm">
                        Scene {scene.sceneNumber}
                      </span>
                      <button 
                        onClick={() => navigator.clipboard.writeText(formatScenePrompt(scene, style))}
                        className="text-gray-500 hover:text-white transition-colors"
                        title="Copy single prompt"
                      >
                         <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className="w-5 h-5">
                            <path strokeLinecap="round" strokeLinejoin="round" d="M15.666 3.888A2.25 2.25 0 0013.5 2.25h-3c-1.03 0-1.9.693-2.166 1.638m7.332 0c.055.194.084.4.084.612v0a.75.75 0 01-.75.75H9a.75.75 0 01-.75-.75v0c0-.212.03-.418.084-.612m7.332 0c.646.049 1.288.11 1.927.184 1.1.128 1.907 1.077 1.907 2.185V19.5a2.25 2.25 0 01-2.25 2.25H6.75A2.25 2.25 0 014.5 19.5V6.257c0-1.108.806-2.057 1.907-2.185a48.208 48.208 0 011.927-.184" />
                          </svg>
                      </button>
                    </div>

                    <div className="prose prose-invert max-w-none">
                      <div className="font-serif text-xl md:text-2xl text-white mb-6 leading-relaxed italic border-l-2 border-gray-700 pl-4">
                        “{scene.description}”
                      </div>
                      
                      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-y-4 gap-x-8 text-sm text-gray-300">
                        <div>
                          <strong className="text-cinema-accent block text-xs uppercase tracking-widest mb-1">Visual Tone</strong>
                          {scene.visualTone}
                        </div>
                        <div>
                          <strong className="text-cinema-accent block text-xs uppercase tracking-widest mb-1">Camera</strong>
                          {scene.camera}
                        </div>
                         <div>
                          <strong className="text-cinema-accent block text-xs uppercase tracking-widest mb-1">Lighting</strong>
                          {scene.lighting}
                        </div>
                        <div>
                          <strong className="text-cinema-accent block text-xs uppercase tracking-widest mb-1">Colors</strong>
                          {scene.colors}
                        </div>
                        <div className="md:col-span-2 lg:col-span-2">
                           <strong className="text-cinema-accent block text-xs uppercase tracking-widest mb-1">Consistency</strong>
                           {scene.consistency}
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              ))}
            </div>
            
             <div className="flex justify-center pt-8">
                 <Button onClick={handleDownload} variant="primary" className="shadow-xl shadow-cinema-accent/20">
                   Download HTML Report
                 </Button>
              </div>
          </div>
        )}
      </main>
    </div>
  );
};

export default App;